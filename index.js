!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("pluralize"),require("seedrandom"),require("fs-jetpack")):"function"==typeof define&&define.amd?define(["pluralize","seedrandom","fs-jetpack"],e):r.Deutung=e(r.$,r.$,r.$)}(this,function(r,e,t){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r,e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var n=function(r,e){var t=/::\.|[^ ]*::/,n=r;return e.reduce(function(r,e){return r.replace(t,e)},n)},i=function(r,t,n){var i=n?e(n):e();return Math.floor(i()*(t-r))+r},o={between:function(r,e){var t=r.split("-").map(Number);return i(t[0],t[1],e)},capitalize:function(r){return r[0].toUpperCase()+r.slice(1)},checkIfAlreadyGenerated:function(r,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Object.keys(r).reduce(function(t,n){return"type"===n?t:r[n]===e[n]?t+=1:t},0)>=t},modifier:function(r){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=r.split("|");return function(){return function r(t,n){var i=e[n[0]]?e[n[0]].call(null,t):t;return 1===n.length?i:r(i,n.slice(1))}(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t)}},pluralize:function(e){return r(e)},possessive:function(r){return r+"'s"},sample:function(r,e){return"string"==typeof r?r:r[i(0,r.length,e)]},uppercase:function(r){return r.toUpperCase()}},a=function(){return function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,e){var t=[],n=!0,i=!1,o=void 0;try{for(var a,u=r[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!e||t.length!==e);n=!0);}catch(r){i=!0,o=r}finally{try{!n&&u.return&&u.return()}finally{if(i)throw o}}return t}(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=o.sample,c=function(r){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments[2];return Object.keys(r).reduce(function(n,i){if("|"===r[i][0]){var o=r[i].slice(1).split(":"),c=a(o,2),l=c[0],s=c[1];n[i]=e[l]?e[l](s,t):r[i]}else n[i]=u(r[i],t);return n},{})};var l=function(r){switch(!0){case"|"===r[0][0]:return"helper";case"!"===r[0][0]:return"grammar";case r[r.length-1].includes("|"):return"modifiedModel";default:return"model"}},s=function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=/::\.|[^ ]*::/g;return e.replace(n,function(e){if("!"!==e[2])return e;var i=e.slice(3,-2).split("."),o=i.reduce(function(r,e){return r[e]?r[e]:new Error("The grammar: "+i+" does not appear to exist")},t);return o instanceof Error?o:null===o.match(n)?o:r(o,t)})},f=function(r){var e=r.match(/::\.|[^ ]*::/g);return null===e?[]:e},p=function(r){var e=function(r,e){switch(r){case"helper":return{type:r,helper:e[0],input:e[1]};case"grammar":return{type:r,grammar:e[0]};default:return{type:r,toParse:e}}};return r.map(function(r){var t=r.slice(2,-2).split("."),n=l(t);if("helper"===n)return e(n,t[0].slice(1).split(":"));if("grammar"===n){var i=[t[0].slice(1)].concat(function(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}return Array.from(r)}(t.slice(1))).join(".");return e(n,[i])}var o,a=t.pop().split("|"),u=(o=a,Array.isArray(o)?o:Array.from(o)),c=u[0],s=u.slice(1);return e(n,"modifiedModel"===n?t.concat(c,[s]):t.concat(c))})},d=function(r){var e={modCha:["model","character","property","modifier"],mod:["model","property","modifier"],cha:["model","character","property"],gen:["model","property"]};return r.map(function(r){return"helper"===r.type||"grammar"===r.type?r:("modifiedModel"===r.type?4===r.toParse.length?e.modCha:e.mod:3===r.toParse.length?e.cha:e.gen).reduce(function(e,t,n){return e[t]=r.toParse[n],Object.assign({},e,{type:"model"})},{})})},m=function(r,e){var t=s(r,e),n=f(t);return n=p(n),{toModel:n=d(n),expandedGrammar:t}};function h(r,e){for(var t=0,n=r.length-1;n>=0;n--){var i=r[n];"."===i?r.splice(n,1):".."===i?(r.splice(n,1),t++):t&&(r.splice(n,1),t--)}if(e)for(;t--;t)r.unshift("..");return r}var v=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,g=function(r){return v.exec(r).slice(1)};function y(){for(var r="",e=!1,t=arguments.length-1;t>=-1&&!e;t--){var n=t>=0?arguments[t]:"/";if("string"!=typeof n)throw new TypeError("Arguments to path.resolve must be strings");n&&(r=n+"/"+r,e="/"===n.charAt(0))}return(e?"/":"")+(r=h(E(r.split("/"),function(r){return!!r}),!e).join("/"))||"."}function b(r){var e=j(r),t="/"===M(r,-1);return(r=h(E(r.split("/"),function(r){return!!r}),!e).join("/"))||e||(r="."),r&&t&&(r+="/"),(e?"/":"")+r}function j(r){return"/"===r.charAt(0)}function A(){return b(E(Array.prototype.slice.call(arguments,0),function(r,e){if("string"!=typeof r)throw new TypeError("Arguments to path.join must be strings");return r}).join("/"))}function w(r,e){function t(r){for(var e=0;e<r.length&&""===r[e];e++);for(var t=r.length-1;t>=0&&""===r[t];t--);return e>t?[]:r.slice(e,t-e+1)}r=y(r).substr(1),e=y(e).substr(1);for(var n=t(r.split("/")),i=t(e.split("/")),o=Math.min(n.length,i.length),a=o,u=0;u<o;u++)if(n[u]!==i[u]){a=u;break}var c=[];for(u=a;u<n.length;u++)c.push("..");return(c=c.concat(i.slice(a))).join("/")}function O(r){var e=g(r),t=e[0],n=e[1];return t||n?(n&&(n=n.substr(0,n.length-1)),t+n):"."}function x(r,e){var t=g(r)[2];return e&&t.substr(-1*e.length)===e&&(t=t.substr(0,t.length-e.length)),t}function k(r){return g(r)[3]}var z={extname:k,basename:x,dirname:O,sep:"/",delimiter:":",relative:w,join:A,isAbsolute:j,normalize:b,resolve:y};function E(r,e){if(r.filter)return r.filter(e);for(var t=[],n=0;n<r.length;n++)e(r[n],n,r)&&t.push(r[n]);return t}var M="b"==="ab".substr(-1)?function(r,e,t){return r.substr(e,t)}:function(r,e,t){return e<0&&(e=r.length+e),r.substr(e,t)},P=Object.freeze({resolve:y,normalize:b,isAbsolute:j,join:A,relative:w,sep:"/",delimiter:":",dirname:O,basename:x,extname:k,default:z}),C=P&&z||P,T=function(r){return t.find(C.resolve(""+r),{matching:"*.json"}).reduce(function(r,e){var n=t.read(e,"json");return["model","grammar"].forEach(function(e){n[e]&&Object.keys(n[e]).forEach(function(t){r[e][t]?r[e][t]=[].concat(r[e][t],n[e][t]):r[e][t]=n[e][t]})}),n.entry&&(r.entry=n.entry),Object.assign({},r)},{model:{},grammar:{},entry:null})};return function(r){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=e.seed,i=e.state?e.state:{},a=e.modifiers?e.modifiers:{},u="string"==typeof r?T(r):r;i="string"==typeof i?T(i):i,a=Object.assign({},o,a);var l=u.grammar,s=m(u.entry,l),f=s.expandedGrammar,p=s.toModel.map(function(r){if("helper"===r.type)return a[r.helper](r.input);var e=i[r.character]||c(u.model[r.model],a,t);r.character&&(i[r.character]=e);var n=e[r.property];return r.modifier&&(n=r.modifier.reduce(function(r,e){return(0,a[e])(r,t)},n)),n});return{compiled:n(f,p),state:i}}});
